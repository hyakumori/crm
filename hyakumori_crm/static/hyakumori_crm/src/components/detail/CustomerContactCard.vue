<template>
  <v-card
    :color="mode != 'view' && selected ? '#f5f5f5' : undefined"
    class="customer-contact-card d-flex d-hover"
    :class="{ flat: flat, deleted: deleted, added: added }"
    outlined
    active-class="selected"
    :ripple="mode != 'view'"
    @click="$emit('click', card_id, index)"
  >
    <v-icon class="customer-contact-card__icon">{{
      $t("icon.customer_icon")
    }}</v-icon>

    <div class="customer-contact-card__name d-flex ml-4 flex-column">
      <div class="d-flex justify-space-between">
        <h4 class="body-2">
          {{ fullname }}
          <span class="caption">{{ forestsCount || 0 }} 件の森林</span>
        </h4>

        <p class="green--text mb-0 ml-2 caption">{{ getRelationship }}</p>
      </div>

      <div v-if="address" class="text-truncate">
        <v-icon small>mdi-map-marker</v-icon>
        <span class="ml-1 caption">{{ address }}</span>
      </div>

      <div class="d-flex text-truncate" v-if="email">
        <v-icon small>mdi-email</v-icon>
        <span class="ml-1 caption">{{ email }}</span>
      </div>

      <div class="d-flex">
        <template v-if="phone">
          <v-icon small>mdi-phone</v-icon>
          <span class="ml-1 pr-2 caption">{{ phone }}</span>
        </template>

        <template v-if="cellphone">
          <v-icon small>mdi-cellphone</v-icon>
          <span class="ml-1 caption">{{ cellphone }}</span>
        </template>
      </div>

      <div
        class="customer-contact-card__related-info caption black--text mt-1"
        v-if="relatedInfo"
      >
        {{ relatedInfo }}
      </div>

      <v-select
        v-if="isUpdate && showRelationshipSelect"
        class="customer-contact-card__select-relationship mt-2"
        outlined
        dense
        hide-details
        placeholder="続き柄を選択"
        :items="RELATIONSHIP"
        @change="selectedRelationship"
      ></v-select>
      <p v-if="forestId">{{ forestId }}</p>
    </div>
    <v-btn
      v-if="deleted"
      class="align-self-center"
      icon
      @click.stop="$emit('undoDeleteContact')"
    >
      <v-icon>mdi-undo</v-icon>
    </v-btn>
    <router-link
      v-if="showAction && !deleted"
      :to="{ name: 'customer-detail', params: { id: card_id } }"
      v-slot="{ href }"
    >
      <v-btn
        class="align-self-center"
        icon
        @click.stop="isUpdate ? $emit('deleteContact') : undefined"
        :href="isUpdate ? null : href"
      >
        <v-icon>{{ actionIcon }}</v-icon>
      </v-btn>
    </router-link>

    <div
      v-if="mode !== 'search'"
      class="customer-contact-card__tag"
      v-bind:class="{
        owner: isOwner,
        contactor: isContactor,
        default: is_default,
      }"
      @click.stop="is_default = !is_default"
    ></div>
  </v-card>
</template>

<script>
export default {
  name: "customer-contact-card",
  relationship: String,

  props: {
    card_id: String,
    relationship: String,
    relatedInfo: String,
    isOwner: Boolean,
    isContactor: Boolean,
    isUpdate: Boolean,
    showAction: { type: Boolean, default: true },
    flat: { type: Boolean, default: false },
    deleted: { type: Boolean, default: false },
    added: { type: Boolean, default: false },
    selectedId: String,
    index: Number,
    handleDeleteClick: Function,
    mode: { type: String, default: "view" },
    showRelationshipSelect: { type: Boolean, default: true },
    contact: Object,
  },

  data() {
    return {
      RELATIONSHIP: [
        this.$t("detail.tabs.relationship.owner"),
        this.$t("detail.tabs.relationship.parent"),
        this.$t("detail.tabs.relationship.husband"),
        this.$t("detail.tabs.relationship.wife"),
        this.$t("detail.tabs.relationship.son"),
        this.$t("detail.tabs.relationship.daughter"),
        this.$t("detail.tabs.relationship.grand_child"),
        this.$t("detail.tabs.relationship.friend"),
        this.$t("detail.tabs.relationship.relatives"),
        this.$t("detail.tabs.relationship.others"),
      ],
      innerRelationship: "",
      is_default: false,
    };
  },

  methods: {
    onClick() {
      // Do click card
      if (this.card_id) {
        this.$router.push({
          name: "customer-detail",
          params: { id: this.card_id },
        });
        window.scrollTo(0, 0);
      }
    },

    onClickCard() {},

    selectedRelationship(val) {
      this.innerRelationship = val;
    },
  },

  computed: {
    contact_() {
      return this.contact.self_contact
        ? this.contact.self_contact
        : this.contact;
    },
    fullname() {
      return `${this.contact_.name_kanji.last_name} ${this.contact_.name_kanji.first_name}`;
    },
    address() {
      return `${this.contact_.postal_code || ""} ${
        this.contact_.address.sector
      } ${this.contact_.address.municipality} ${
        this.contact_.address.prefecture
      }`;
    },
    email() {
      return this.contact_.email;
    },
    phone() {
      return this.contact_.telephone;
    },
    cellphone() {
      return this.contact_.mobilephone;
    },
    forestId() {
      return this.contact.forest_id;
    },
    forestsCount() {
      return this.contact.forests_count;
    },
    actionIcon() {
      return this.isUpdate ? "mdi-close" : "mdi-chevron-right";
    },
    selected() {
      return this.selectedId === this.card_id;
    },
    getRelationship() {
      if (this.relationship) {
        return this.relationship;
      } else {
        return this.innerRelationship;
      }
    },
  },
};
</script>

<style lang="scss" scoped>
$border-radius: 8px;
$background-color: #f5f5f5;

.customer-contact-card::before {
  border-radius: $border-radius;
}

.customer-contact-card.flat {
  border: none !important;
  border-radius: 0 !important;
  border-bottom: 1px solid #e1e1e1 !important;
}

.customer-contact-card.deleted {
  border: 1px solid #ff5252 !important;
}

.customer-contact-card.added {
  border: 1px solid #12c7a6 !important;
}

.customer-contact-card {
  width: 100%;
  min-height: 116px;
  max-height: 100%;
  padding: 10px;
  border-radius: $border-radius !important;
  border: 1px solid #e1e1e1 !important;
  position: relative;

  &:focus::before {
    opacity: 0 !important;
  }

  &__icon {
    padding: 10px;
    background-color: $background-color;
    align-self: center;
    border-radius: 50% !important;
  }

  &__name {
    height: inherit;
    width: 100%;
    max-width: 234px;
    align-self: center;

    span {
      color: #999999;
    }
  }

  &__tag {
    position: absolute;
    right: 0;
    top: 0;
    height: 30px;
    width: 30px;
    border-radius: unset !important;
    border-top-right-radius: $border-radius !important;
    clip-path: polygon(0 0, 100% 100%, 100% 0);
    background-color: #e1e1e1;
    opacity: 0.45;
    &:hover {
      opacity: 1;
    }
  }

  & .owner.default {
    background-color: #12c7a6;
    opacity: 1;
  }

  & .contactor.default {
    opacity: 1;
    background-color: #f36c69;
  }

  &__related-info {
    background-color: $background-color;
    padding: 4px;
    width: fit-content;
    border-radius: 2px;
  }

  &__select-relationship ::v-deep {
    width: 220px;

    fieldset {
      border: 1px solid #eeeeee;
      border-radius: 4px;
    }

    .v-icon {
      margin-top: 0 !important;
    }

    .v-select__selection {
      color: #999999;
    }
  }
}
</style>
